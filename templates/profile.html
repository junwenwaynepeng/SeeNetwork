{% extends 'base.html' %}
{% load static %}
{% load martortags %}
{% block stylesheet %}
  <link rel="stylesheet" href="{% static 'css/dark-light.css' %}">
  <link rel="stylesheet" href="{% static 'css/drag-drop.css' %}">
  <link href="{% static 'plugins/css/ace.min.css' %}" type="text/css" media="all" rel="stylesheet" />
  <link href="{% static 'plugins/css/resizable.min.css' %}" type="text/css" media="all" rel="stylesheet" />
  <link href="{% static 'martor/css/martor.bootstrap.min.css' %}" type="text/css" media="all" rel="stylesheet" />
{% endblock %}
{% load user_filter %}
{% block title %}User Profile{% endblock %}

{% block content %}
  <div class="container-fluid adaptive">
    <div class="row">
      <!-- Left Section -->
      <div class="col-md-4">
        <div class="card w-100 profile-adaptive">
          <div class="card-body">
            <h5 class="card-title fs-3 fw-bolder profile-adaptive">基本資料</h5>

            <div class="mb-3">
              <label id="student_id" class="form-label fs-6 profile-adaptive">學生 ID</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.student_id }}</p>
            </div>

            <div class="mb-3">
              <label id="first_name" class="form-label fs-6 profile-adaptive">姓名</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.first_name }}, {{ profile_owner.last_name }}</p>
            </div>

            <div class="mb-3">
              <label id="nick_name" class="form-label fs-6 profile-adaptive">a.k.a.</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.nick_name }}</p>
            </div>

            <div class="mb-3">
              <label id="gender" class="form-label fs-6 profile-adaptive">性別</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.get_gender_display }}</p>
            </div>

            <div class="mb-3">
              <label id="department" class="form-label fs-6 profile-adaptive">系所</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.get_department_display }}</p>
            </div>

            <div class="mb-3">
              <label id="email" class="form-label fs-6 profile-adaptive">電子郵件</label>
              <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ profile_owner.email }}</p>
            </div>
            {% if profile_owner.slug == user.slug %}
              <div class="text-right adaptive">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#profileModal">編輯</button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <!-- Content for the right section goes here -->
        <ul class="drag-drop" style="list-style-type: none;">
          {% for card in cards %}
            <li id="delete-item-{{ card.model }}-{{ card.card_id }}" class="drag-drop" value="{{ card.order }}" draggable="true">
              <div class="card w-100 profile-adaptive">
                <div class="card-body">
                  <div class="mb-3">
                    <label id="delete-item-{{card.modal}}-{{card.card_id}}" class="form-label fs-6 profile-adaptive">{{ card.title }}
                      {% if profile_owner.slug == user.slug %}
                        {% if card.model == 'selfIntroduction' or card.card_id %} 
                          <button type="button" class="btn btn-link float-end" data-bs-toggle="modal" data-bs-target="#{{ card.model }}Modal">
                            <i class="fa fa-pencil"></i>
                          </button>
                        {% endif %}
                      {% endif %}
                    </label>
                      {% if profile_owner.slug == user.slug %}
                        {% if card.card_id %}
                          <button type="button" class="btn btn-link float-end" onclick="deleteItem('{{ card.model }}', {{ card.card_id }})">
                            <i class="fa fa-close"></i>
                          </button>
                        {% endif %}
                      {% endif %}
                    {% if card.is_list %}
                      <ul>
                        {% for item in card.item_list %}
                          <li id="delete-item-{{ card.model }}-{{ item.id }}">
                            <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ item.0 }}
                              {% if profile_owner.slug == user.slug %}
                                <button type="button" class="btn btn-link float-begin" data-bs-toggle="modal" data-bs-target="#edit{{ card.model }}{{ item.0.id }}Modal">
                                  <i class="fa fa-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-link float-end" onclick="deleteItem('{{ card.model }}', {{ item.0.id }})">
                                  <i class="fa fa-minus"></i>
                                </button>
                              {% endif %}
                            </p>
                          </li>
                        {% endfor %}
                      </ul>
                      {% if profile_owner.slug == user.slug %}
                        <button type="button" class="btn btn-link float-end" data-bs-toggle="modal" data-bs-target="#{{ card.model }}Modal">
                          <i class="fa fa-plus"></i>
                        </button>
                      {% endif %}
                    {% else %}
                      <p class="fw-normal ms-2 fs-5 profile-adaptive">{{ card.content | safe_markdown }}</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
        <!--新增自定義欄位按鈕-->
        <button type="button" class="btn btn-link float-end" data-bs-toggle="modal" data-bs-target="#selfDefinedContentModal">
          <i class="fa fa-plus">新增自定義欄位</i>
        </button>
      </div>
    </div>
  </div>

  {% if profile_owner.slug  == user.slug %}
  {% load crispy_forms_tags %}
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">修改基本資料</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'save_profile' %}">
              {% csrf_token %}
              {{ profile_form | crispy}}
              <div class="modal-footer">
               <button type="submit" class="btn btn-primary">Save changes</button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    {% for card in cards %}
      <div class="modal fade" id="{{ card.model }}Modal" tabindex="-1" aria-labelledby="{{ card.model }}ModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="{{ card.model }}ModalLabel">{{ card.edit_title }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form method="post" action="{% url 'save_other_profile' card.model %}">
                {% csrf_token %}
                {{ card.form | crispy }}
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Save changes</button>
                  {% if card.card_id %}
                    <button type="button" class="btn btn-primary float-end" onclick="deleteItem('{{ card.model }}', {{ card.card_id }})">
                      Delete this card
                    </button>
                  {% endif %}
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      {% for item in card.item_list %}
        <div class="modal fade" id="edit{{ card.model }}{{ item.0.id }}Modal" tabindex="-1" aria-labelledby="edit{{ card.model }}{{ item.0.id }}ModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="edit{{ card.model }}ModalLabel">編輯{{ card.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form method="post" action="{% url 'save_other_profile' card.model %}">
                  {% csrf_token %}
                  {{ item.1 | crispy }}
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save changes</button>  
                    <button type="button" class="btn btn-primary float-end" onclick="deleteItem('{{ card.model }}', {{ item.0.id }})">
                      Delete this item
                    </button>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endfor %}
    <!--新增自定義欄位-->
    <div class="modal fade" id="selfDefinedContentModal" tabindex="-1" aria-labelledby="selfDefinedContentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="selfDefinedContentModalLabel">新增自定義欄位</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{% url 'save_other_profile' 'selfDefinedContent' %}">
              {% csrf_token %}
              {{ empty_self_defined_content_form | crispy }}
              <div class="modal-footer">
               <button type="submit" class="btn btn-primary">Save changes</button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  {% endif %}



{% endblock %}

{% block scripts %}
{% if profile_owner.slug == user.slug %}
  <script>
    window.onbeforeunload = function(){
      const cvCard = $('li.drag-drop').map(function () {
        return $(this).attr("value")
      }).toArray();
      console.log(cvCard);
      return new Promise((resolve, reject) => {
        fetch('{% url 'save_cv_card_order' %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({ cvCard: cvCard   }),
                })
                .then(response => response.json())
                .then(data => {
                    // Update the UI or perform additional actions if needed
                    console.log('Save cv card order', data);
                })
                .catch(error => console.error('Error save cv card order:', error));
              });
      $(window).unbind();
      return undefined;
    };
  </script>
  <script>
    var dragging = null;

    document.addEventListener('dragstart', function(event) {
        var target = getLI( event.target );
        dragging = target;
        event.dataTransfer.setData('text/plain', null);
        event.dataTransfer.setDragImage(self.dragging,0,0);
    });

    document.addEventListener('dragover', function(event) {
        event.preventDefault();
        var target = getLI( event.target );
        var bounding = target.getBoundingClientRect()
        var offset = bounding.y + (bounding.height/2);
        if ( event.clientY - offset > 0 ) {
            target.style['border-bottom'] = 'solid 4px blue';
            target.style['border-top'] = '';
        } else {
            target.style['border-top'] = 'solid 4px blue';
            target.style['border-bottom'] = '';
        }
    });

    document.addEventListener('dragleave', function(event) {
        var target = getLI( event.target );
        target.style['border-bottom'] = '';
        target.style['border-top'] = '';
    });

    document.addEventListener('drop', function(event) {
        event.preventDefault();
        var target = getLI( event.target );
        if ( target.style['border-bottom'] !== '' ) {
            target.style['border-bottom'] = '';
            target.parentNode.insertBefore(dragging, event.target.nextSibling);
        } else {
            target.style['border-top'] = '';
            target.parentNode.insertBefore(dragging, event.target);
        }
    });

    function getLI( target ) {
        while ( target.nodeName.toLowerCase() != 'li' && target.nodeName.toLowerCase() != 'body' ) {
            target = target.parentNode;
        }
        if ( target.nodeName.toLowerCase() == 'body' ) {
            return false;
        } else {
            return target;
        }
    }
  </script>

  <script>
    function deleteItem(model, itemId) {
      var contentId = 'delete-item-' + model + '-' + itemId;
      var formData = {
        itemId: itemId, 
        model: model, 
      };

      // Ask for confirmation before deleting
      var confirmDelete = window.confirm("Are you sure you want to delete this item?");
      if (!confirmDelete) {
          return;
      }

      const content = document.getElementById(contentId);
      content.remove();

      $.ajax({
          type: 'DELETE',
          url: '/delete_profile_item',  // Replace with your actual endpoint
          contentType: 'application/json',  // Set content type to JSON
          data: JSON.stringify(formData),
          headers: {'X-CSRFToken': '{{ csrf_token }}' },
          success: function(response) {
              // Handle the server response here
              console.log('success');
          },
          error: function(error) {
              // Handle errors here
              console.error(error);
          }
      });
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/js/jquery-1.8.3.min.js" integrity="sha512-J9QfbPuFlqGD2CYVCa6zn8/7PEgZnGpM5qtFOBZgwujjDnG5w5Fjx46YzqvIh/ORstcj7luStvvIHkisQi5SKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    $('.martor-preview pre').each(function(i, block){
        hljs.highlightBlock(block);
    });
  </script>
  <script type="text/javascript" src="{% static 'plugins/js/ace.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/mode-markdown.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/ext-language_tools.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/theme-github.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/typo.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/spellcheck.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/highlight.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/resizable.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/emojis.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'martor/js/martor.bootstrap.min.js' %}"></script>
{% endif %}
{% endblock %}